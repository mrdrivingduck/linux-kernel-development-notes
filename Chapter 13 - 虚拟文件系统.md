# Chapter 13 - è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ

Created by : Mr Dk.

2019 / 10 / 26 21:23

Nanjing, Jiangsu, China

---

è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ VFS æ˜¯å†…æ ¸å­ç³»ç»Ÿä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºæä¾›äº†æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ¥å£ã€‚é€šè¿‡ VFSï¼Œç¨‹åºå¯ä»¥åˆ©ç”¨æ ‡å‡†çš„ Unix ç³»ç»Ÿè°ƒç”¨å¯¹ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œç”šè‡³ä¸åŒä»‹è´¨ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œè¯»å†™æ“ä½œã€‚

## 13.1 é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¥å£

VFS ä½¿ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ— éœ€è€ƒè™‘ **å…·ä½“æ–‡ä»¶ç³»ç»Ÿ** å’Œ **å®é™…ç‰©ç†ä»‹è´¨**ã€‚å³è¿™äº›é€šç”¨ç³»ç»Ÿè°ƒç”¨å¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿã€è·¨ä»‹è´¨æ‰§è¡Œã€‚è€å¼çš„æ“ä½œç³»ç»Ÿ (æ¯”å¦‚ DOS) æ— åŠ›å®Œæˆä¸Šè¿°å·¥ä½œã€‚é€šè¿‡è™šæ‹Ÿæ¥å£è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰ä½¿å¾—è¿™ç§åä½œæ€§å’Œæ³›å‹å­˜å–ç§°ä¸ºå¯èƒ½ã€‚VFS å°†å„ç§ä¸åŒçš„æ–‡ä»¶ç³»ç»ŸæŠ½è±¡åï¼Œé‡‡ç”¨ç»Ÿä¸€çš„æ–¹å¼è¿›è¡Œæ“ä½œã€‚

## 13.2 æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚

ä¹‹æ‰€ä»¥å¯ä»¥ç”¨é€šç”¨æ¥å£å¯¹å„ç§ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ“ä½œï¼Œæ˜¯å› ä¸ºå†…æ ¸åœ¨å®ƒçš„åº•å±‚æ–‡ä»¶ç³»ç»Ÿæ¥å£ä¸Šå»ºç«‹äº†ä¸€ä¸ª **æŠ½è±¡å±‚**ï¼Œè¯¥æŠ½è±¡å±‚ä½¿ Linux èƒ½å¤Ÿæ”¯æŒå„ç§æ–‡ä»¶ç³»ç»Ÿã€‚VFS æä¾›äº†ä¸€ä¸ª **é€šç”¨æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹**ï¼Œå›Šæ‹¬äº†ä»»ä½•æ–‡ä»¶ç³»ç»Ÿå¸¸ç”¨çš„åŠŸèƒ½é›†å’Œè¡Œä¸ºï¼Œè™½åé‡äº Unix é£æ ¼çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†ä¾ç„¶å¯ä»¥æ”¯æŒå¾ˆå¤šç§å·®å¼‚å¾ˆå¤§çš„æ–‡ä»¶ç³»ç»Ÿã€‚æŠ½è±¡å±‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿè¡”æ¥å„ç§å„æ ·çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯å› ä¸ºå®šä¹‰äº†æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿéƒ½æ”¯æŒçš„ã€åŸºæœ¬çš„ã€æ¦‚å¿µä¸Šçš„æ¥å£å’Œæ•°æ®ç»“æ„ã€‚å®é™…æ–‡ä»¶ç³»ç»Ÿçš„ä»£ç åœ¨ç»Ÿä¸€çš„æ¥å£å’Œæ•°æ®ç»“æ„ä¸‹éšè—äº†å…·ä½“å®ç°ç»†èŠ‚ï¼Œåœ¨ VFS å±‚é¢ä¸Šï¼Œæ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯ç›¸åŒçš„ã€‚å®é™…æ–‡ä»¶ç³»ç»Ÿéœ€è¦é€šè¿‡ç¼–ç¨‹æä¾› VFS æ‰€æœŸæœ›çš„æŠ½è±¡æ¥å£å’Œæ•°æ®ç»“æ„ã€‚

## 13.3 Unix æ–‡ä»¶ç³»ç»Ÿ

Unix ä½¿ç”¨äº†å››ç§å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æŠ½è±¡æ¦‚å¿µï¼š

- æ–‡ä»¶
- ç›®å½•é¡¹
- ç´¢å¼•ç»“ç‚¹ (inode)
- å®‰è£…ç‚¹ (mount point)

åœ¨ Unix ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿè¢«å®‰è£…åœ¨ä¸€ä¸ªç‰¹å®šçš„å®‰è£…ç‚¹ä¸Šã€‚æ‰€æœ‰å·²å®‰è£…æ–‡ä»¶ç³»ç»Ÿéƒ½ä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿæ ‘çš„æå¶å‡ºç°åœ¨ç³»ç»Ÿä¸­ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒWindows å°†å‘½åç©ºé—´åˆ†ç±»ä¸ºé©±åŠ¨å™¨å­—æ¯ï¼Œå°†ç¡¬ä»¶ç»†èŠ‚æ³„éœ²ç»™æ–‡ä»¶ç³»ç»Ÿçš„æŠ½è±¡å±‚ã€‚

æ–‡ä»¶é€šè¿‡ç›®å½•ç»„ç»‡èµ·æ¥ï¼Œç›®å½•æ¡ç›®è¢«ç§°ä¸ºç›®å½•é¡¹ï¼ŒVFS æŠŠç›®å½•å½“æˆæ™®é€šæ–‡ä»¶å¯¹å¾…ã€‚Unix å°†æ–‡ä»¶çš„ **ç›¸å…³ä¿¡æ¯** å’Œ **æ–‡ä»¶æœ¬èº«** åŠ ä»¥åŒºåˆ†ï¼šæ–‡ä»¶çš„ç›¸å…³ä¿¡æ¯è¢«ç§°ä¸º **å…ƒæ•°æ®** ï¼Œè¢«å­˜å‚¨åœ¨ä¸“é—¨çš„æ•°æ®ç»“æ„ inode ä¸­ã€‚æ–‡ä»¶ç³»ç»Ÿçš„æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨ **è¶…çº§å—** ä¸­ï¼ŒåŒ…å«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯çš„æ•°æ®ç»“æ„ã€‚ä¸€ç›´ä»¥æ¥ï¼ŒUnix æ–‡ä»¶ç³»ç»Ÿåœ¨ç£ç›˜ä¸Šçš„å¸ƒå±€ä¹Ÿæ˜¯æŒ‰ç…§ä¸Šè¿°æ¦‚å¿µå®ç°çš„ã€‚

FATã€NTFS ç­‰é Unix é£æ ¼çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè™½ç„¶ä¹Ÿå¯ä»¥åœ¨ Linux ä¸Šå·¥ä½œï¼Œä½†å¿…é¡»ç»è¿‡å°è£…ï¼Œæä¾›ä¸€ä¸ªç¬¦åˆ VFS é€šç”¨æ¨¡å‹çš„ç•Œé¢ï¼Œä½¿å¾—é Unix çš„æ–‡ä»¶ç³»ç»Ÿèƒ½å¤Ÿå…¼å®¹ Unix æ–‡ä»¶ç³»ç»Ÿçš„ä½¿ç”¨è§„åˆ™ã€‚è¿™ç§æ–‡ä»¶ç³»ç»Ÿå¯ä»¥å·¥ä½œï¼Œä½†æ˜¯å¸¦æ¥çš„å¼€é”€ä¸å¯æ€è®® ğŸ˜Œ

## 13.4 VFS å¯¹è±¡åŠå…¶æ•°æ®ç»“æ„

VFS é‡‡ç”¨äº†é¢å‘å¯¹è±¡çš„è®¾è®¡æ€è·¯ã€‚å†…æ ¸ä¸­çš„æ‰€æœ‰æ•°æ®ç»“æ„éƒ½ä½¿ç”¨ C è¯­è¨€çš„ç»“æ„ä½“å®ç°ï¼Œè¿™äº›ç»“æ„ä½“åŒ…å«æ•°æ®çš„åŒæ—¶ï¼Œä¹ŸåŒ…å«æ“ä½œè¿™äº›æ•°æ®çš„å‡½æ•°æŒ‡é’ˆã€‚å…¶ä¸­çš„æ“ä½œå‡½æ•° **ç”±å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°**ã€‚VFS ä¸­æœ‰å››ä¸ªä¸»è¦å¯¹è±¡ç±»å‹ï¼š

- è¶…çº§å—å¯¹è±¡ï¼šä»£è¡¨ä¸€ä¸ª **å·²å®‰è£…** çš„æ–‡ä»¶ç³»ç»Ÿ
- inode å¯¹è±¡ï¼šä»£è¡¨ä¸€ä¸ªå…·ä½“æ–‡ä»¶
- ç›®å½•é¡¹å¯¹è±¡ï¼šä»£è¡¨ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ˜¯è·¯å¾„çš„ç»„æˆéƒ¨åˆ†
- æ–‡ä»¶å¯¹è±¡ï¼šä»£è¡¨ç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶

æ¯ä¸ªå¯¹è±¡ä¸­åŒ…å«ä¸€ä¸ª **æ“ä½œå¯¹è±¡**ï¼ŒåŒ…å«äº†å†…æ ¸å¯¹è¿™äº›ä¸»è¦å¯¹è±¡å¯ä»¥ä½¿ç”¨çš„å‡½æ•°ï¼š

- `super_operations`ï¼šé’ˆå¯¹æ–‡ä»¶ç³»ç»Ÿæ‰€èƒ½è°ƒç”¨çš„å‡½æ•°
- `inode_operations`ï¼šå†…æ ¸é’ˆå¯¹ç‰¹å®šæ–‡ä»¶æ‰€èƒ½è°ƒç”¨çš„å‡½æ•°
- `dentry_operations`ï¼šå†…æ ¸é’ˆå¯¹ç‰¹å®šç›®å½•æ‰€èƒ½è°ƒç”¨çš„å‡½æ•°
- `file_operations`ï¼šè¿›ç¨‹é’ˆå¯¹å·²æ‰“å¼€æ–‡ä»¶æ‰€èƒ½è°ƒç”¨çš„å‡½æ•°

å¯¹äºè®¸å¤šå‡½æ•°ï¼Œå¯ä»¥ç»§æ‰¿ VFS æä¾›çš„é€šç”¨å‡½æ•°ã€‚å¦‚æœé€šç”¨åŠŸèƒ½æ— æ³•æ»¡è¶³ï¼Œåˆ™ä½¿ç”¨å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„ç‹¬æœ‰å‡½æ•°å¡«å……è¿™äº›æŒ‡é’ˆã€‚

## 13.5 è¶…çº§å—å¯¹è±¡

å„ç§æ–‡ä»¶ç³»ç»Ÿéƒ½å¿…é¡»å®ç°è¶…çº§å—å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ã€‚é€šå¸¸å¯¹åº”äºå­˜æ”¾åœ¨ç£ç›˜æ‰‡åŒºä¸­çš„æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—ã€‚å¯¹äºå¹¶éåŸºäºç£ç›˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œç°åœºåˆ›å»ºè¶…çº§å—ï¼Œå¹¶ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚æ–‡ä»¶ç³»ç»Ÿå®‰è£…æ—¶ï¼Œä¼šä»ç£ç›˜ä¸Šè¯»å–æ–‡ä»¶ç³»ç»Ÿè¶…çº§å—ï¼Œå¹¶å°†ä¿¡æ¯å¡«å……åˆ°å†…å­˜ä¸­çš„è¶…çº§å—å¯¹è±¡ä¸­ã€‚

## 13.6 è¶…çº§å—æ“ä½œ

```c
struct super_operations {
    // ...
}
```

è¯¥ç»“æ„ä½“ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ **è¶…çº§å—æ“ä½œå‡½æ•°** çš„æŒ‡é’ˆï¼Œæ‰§è¡Œæ–‡ä»¶ç³»ç»Ÿå’Œç´¢å¼•ç»“ç‚¹çš„ä½å±‚æ“ä½œã€‚åœ¨è¶…çº§å—å¯¹è±¡è°ƒç”¨å‡½æ•°æ—¶ï¼Œå¯èƒ½è¿˜éœ€è¦å°†è¶…çº§å—è‡ªèº«ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’ï¼Œå› ä¸º C ä¸æ”¯æŒé¢å‘å¯¹è±¡ï¼š

```c++
sb.write_super(); // C++ style
```

```c
sb->s_op->write_super(sb); // C style
```

## 13.7 ç´¢å¼•ç»“ç‚¹å¯¹è±¡

inode å¯¹è±¡åŒ…å«äº†å†…æ ¸åœ¨æ“ä½œæ–‡ä»¶æˆ–ç›®å½•æ—¶éœ€è¦çš„å…¨éƒ¨ä¿¡æ¯ã€‚å¯¹äº Unix é£æ ¼çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ç›´æ¥ä»ç£ç›˜è¯»å…¥ï¼›å¯¹äºæ²¡æœ‰ inode çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¿…é¡»æƒ³åŠæ³•æå–è¿™äº›ä¿¡æ¯ï¼Œä¸ç®¡å“ªç§æƒ…å†µã€ä½•ç§æ–¹å¼ï¼Œinode å¯¹è±¡å¿…é¡»åœ¨å†…å­˜ä¸­åˆ›å»ºã€‚ä¸€ä¸ª inode ä»£è¡¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯è®¾å¤‡æˆ–ç®¡é“è¿™æ ·çš„ç‰¹æ®Šæ–‡ä»¶ã€‚ç”±äº inode åªèƒ½æ˜¯è¿™äº›æ–‡ä»¶ä¸­çš„ä¸€ç±»ï¼Œå› æ­¤æŒ‡é’ˆå­˜æ”¾åœ¨ union ä¸­ã€‚

> ç»ˆäºæœ‰ç‚¹æ˜ç™½æ‰€è°“çš„ union æ˜¯å¹²å•¥ç”¨çš„äº† ğŸ˜¥

```c
struct inode {
    // ...
    union {
        struct pipe_inode_info *i_pipe;
        struct block_device *i_bdev;
        struct cdev *i_cdev;
    }
    // ...
}
```

æŸäº›æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸èƒ½å®Œæ•´åœ°åŒ…å« inode ç»“æ„ä½“ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ–‡ä»¶ç³»ç»Ÿå°±éœ€è¦åœ¨å¯¹åº”çš„å®ç°ä¸­è§£å†³è¿™äº›é—®é¢˜ã€‚è¿™æ˜¯ç”±å…·ä½“çš„å®ç°è€…å†³å®šçš„ã€‚

## 13.8 ç´¢å¼•ç»“ç‚¹æ“ä½œ

## 13.9 ç›®å½•é¡¹å¯¹è±¡

VFS æŠŠç›®å½•å½“ä½œæ–‡ä»¶å¯¹å¾…ã€‚ç›®å½•è·¯å¾„ä¸­çš„æ¯ä¸ªç»„æˆéƒ¨åˆ†éƒ½ç”±ä¸€ä¸ª inode å¯¹è±¡è¡¨ç¤ºã€‚è§£æä¸€ä¸ªè·¯å¾„å¹¶éå†æ˜¯ååˆ†è€—æ—¶çš„å­—ç¬¦ä¸²æ¯”è¾ƒè¿‡ç¨‹ï¼Œæ‰§è¡Œè€—æ—¶ã€ä»£ç ç¹çã€‚ç›®å½•é¡¹ **æ²¡æœ‰å¯¹åº”çš„ç£ç›˜æ•°æ®ç»“æ„**ï¼ŒVFS æ ¹æ®å­—ç¬¦ä¸²å½¢å¼çš„è·¯å¾„åç°åœºåˆ›å»ºã€‚

### 13.9.1 ç›®å½•é¡¹çŠ¶æ€

ç›®å½•é¡¹å¯¹è±¡æœ‰ä¸‰ç§çŠ¶æ€ï¼š

- è¢«ä½¿ç”¨
  - å¯¹åº”ä¸€ä¸ªæœ‰æ•ˆçš„ inode
  - å¹¶æŒ‡æ˜è¯¥å¯¹è±¡æœ‰å¤šå°‘ä¸ªä½¿ç”¨è€… (> 0)
- æœªè¢«ä½¿ç”¨
  - å¯¹åº”ä¸€ä¸ªæœ‰æ•ˆçš„ inode
  - VFS å½“å‰æœªä½¿ç”¨å®ƒ (ä½¿ç”¨è€…æ•°ä¸º 0)
  - ä¸ä¼šè¢«è¿‡æ—©æ’¤é”€ï¼Œå¦‚æœä»¥åéœ€è¦ä½¿ç”¨ï¼Œé¿å…é‡æ–°åˆ›å»º
  - å¦‚æœéœ€è¦å›æ”¶å†…å­˜ï¼Œåˆ™å¯ä»¥è¢«æ’¤é”€
- è´ŸçŠ¶æ€
  - ä¸å¯¹åº”æœ‰æ•ˆçš„ inode (inode å·²è¢«åˆ é™¤ï¼Œæˆ–è·¯å¾„ä¸å†æ­£ç¡®)
  - ä¿ç•™ï¼Œä¾¿äºå¿«é€Ÿè§£æä¸€äº›å¤±è´¥çš„è·¯å¾„æŸ¥è¯¢
  - å¦‚æœæœ‰å¿…è¦ï¼Œä¹Ÿå¯ä»¥æ’¤é”€

### 13.9.2 ç›®å½•é¡¹ç¼“å­˜

VFS éå†è·¯å¾„åä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œé€ä¸ªè§£æä¸ºç›®å½•é¡¹å¯¹è±¡ã€‚è¿™æ˜¯å¾ˆè´¹åŠ›çš„å·¥ä½œï¼Œä¼šæµªè´¹å¤§é‡æ—¶é—´ã€‚å†…æ ¸ä¼šå°†ç›®å½•é¡¹ç¼“å­˜ï¼Œç›®å½•é¡¹ç¼“å­˜åŒ…å«ï¼š

- æ­£è¢«ä½¿ç”¨çš„ç›®å½•é¡¹é“¾è¡¨
- æœ€è¿‘è¢«ä½¿ç”¨çš„åŒå‘é“¾è¡¨ï¼šæœªè¢«ä½¿ç”¨çš„å’Œè´ŸçŠ¶æ€çš„ç›®å½•é¡¹å¯¹è±¡
- hash è¡¨ï¼Œç”¨äºå¿«é€Ÿå°†ç»™å®šçš„è·¯å¾„è§£æä¸ºç›¸å…³ç›®å½•é¡¹å¯¹è±¡

ç›®å½•é¡¹å¯¹è±¡å¯¹åº”çš„ inode ä¹Ÿä¼šè¢«ç¼“å­˜ï¼Œåªè¦ç›®å½•é¡¹è¢«ç¼“å­˜äº†ï¼Œå¯¹åº”çš„ inode ä¸€å®šè¢«ç¼“å­˜ã€‚VFS ç°åœ¨ç›®å½•é¡¹ç¼“å­˜ä¸­æœç´¢è·¯å¾„åï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ä¸ç”¨è´¹é‚£ä¹ˆå¤§çš„åŠ›æ°”äº†ã€‚ç”±äºæ–‡ä»¶è®¿é—®å‘ˆç° **æ—¶é—´** å’Œ **ç©ºé—´** çš„å±€éƒ¨æ€§ï¼Œå¯¹ç›®å½•é¡¹å’Œ inode è¿›è¡Œç¼“å­˜éå¸¸æœ‰ç›Šã€‚

## 13.10 ç›®å½•é¡¹æ“ä½œ

## 13.11 æ–‡ä»¶å¯¹è±¡

æ–‡ä»¶å¯¹è±¡æ˜¯å·²æ‰“å¼€çš„æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºï¼Œç”± `open()` åˆ›å»ºï¼Œç”± `close()` æ’¤é”€ã€‚æ–‡ä»¶å¯¹è±¡ä»…ä»…åœ¨è¿›ç¨‹è§‚ç‚¹ä¸Šä»£è¡¨å·²æ‰“å¼€æ–‡ä»¶ï¼Œä¸€ä¸ªæ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡ä¸æ˜¯å”¯ä¸€çš„ã€‚ä½†å¯¹åº”çš„ç´¢å¼•ç»“ç‚¹å’Œç›®å½•é¡¹å¯¹è±¡æ˜¯å”¯ä¸€çš„ï¼Œæ–‡ä»¶å¯¹è±¡å®é™…ä¸Šä¹Ÿæ²¡æœ‰å¯¹åº”çš„ç£ç›˜æ•°æ®ã€‚

## 13.12 æ–‡ä»¶æ“ä½œ

å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿå¯ä»¥ä¸ºæ¯ä¸€ç§æ“ä½œåšä¸“é—¨çš„å®ç°ã€‚å¦‚æœå­˜åœ¨é€šç”¨æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€šç”¨çš„æ“ä½œã€‚

## 13.13 å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„æ•°æ®ç»“æ„

å†…æ ¸è¿˜ä½¿ç”¨äº†å¦å¤–ä¸€äº›æ ‡å‡†æ•°æ®ç»“æ„æ¥ç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å…¶å®ƒç›¸å…³æ•°æ®ï¼Œç”¨äºæè¿°å„ç§ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚

```c
struct file_system_type {
    // ...
};
```

ä½¿å†…æ ¸èƒ½å¤Ÿæ”¯æŒä¼—å¤šä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿã€‚å¯¹äºæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œä¸ç®¡æœ‰æ²¡æœ‰è¢«å®‰è£…åˆ°ç³»ç»Ÿä¸Šï¼Œéƒ½åªæœ‰è¿™æ ·çš„ä¸€ä¸ª `file_system_type` ç»“æ„ã€‚å½“æ–‡ä»¶ç³»ç»Ÿè¢«å®é™…å®‰è£…æ—¶ï¼Œåœ¨å®‰è£…ç‚¹ä¼šåˆ›å»ºä¸€ä¸ª `vfsmount` ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ä»£è¡¨äº†æ–‡ä»¶ç³»ç»Ÿçš„å®ä¾‹ã€‚

## 13.14 å’Œè¿›ç¨‹ç›¸å…³çš„æ•°æ®ç»“æ„

`file_struct` ç»“æ„ä½“ç”± PCB ä¸­çš„ files ç›®å½•é¡¹æŒ‡å‘ï¼Œæ‰€æœ‰ä¸ **å•ä¸ªè¿›ç¨‹** ç›¸å…³çš„ä¿¡æ¯éƒ½åŒ…å«åœ¨å…¶ä¸­ã€‚

```c
struct files_struct {
    atomic_t count;
    struct fdtable *fdt;
    struct fdtable fdtab;
    spinlock_t file_lock;
    int next_fd;
    struct embedded_fd_set close_on_exec_init;
    struct embedded_fd_set open_fds_init;
    struct file *fd_array[NR_OPEN_DEFAULT];
};
```

`fd_array` æ•°ç»„æŒ‡é’ˆæŒ‡å‘å·²ç»æ‰“å¼€çš„æ–‡ä»¶å¯¹è±¡ã€‚å¦‚æœè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶å¯¹è±¡è¶…è¿‡ `NR_OPEN_DEFAULT`ï¼Œå†…æ ¸å°†åˆ†é…æ–°æ•°ç»„ï¼Œå¹¶ä½¿ `fdt` æŒ‡é’ˆæŒ‡å‘å®ƒã€‚å› æ­¤è¿›ç¨‹å¯¹é€‚å½“æ•°é‡çš„æ–‡ä»¶å¯¹è±¡çš„è®¿é—®ä¼šæ‰§è¡Œå¾—å¾ˆå¿«ã€‚å…¶æ¬¡æ˜¯ `fs_struct` ç»“æ„ä½“ï¼Œç”± PCB ä¸­çš„ `fs` åŸŸæ‰€æŒ‡å‘ï¼ŒåŒ…å«æ–‡ä»¶ç³»ç»Ÿå’Œè¿›ç¨‹ç›¸å…³çš„ä¿¡æ¯ã€‚

```c
struct fs_struct {
    int users;
    rwlock_t lock;
    int umask;
    int in_exec;
    struct path root;
    struct path pwd;
};
```

åŒ…å«äº†å½“å‰è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½• (pwd) å’Œæ ¹ç›®å½•ã€‚

ç¬¬ä¸‰ä¸ªç»“æ„ä½“æ˜¯ `namespace` ç»“æ„ä½“ï¼Œç”± PCB ä¸­çš„ `mmt_namespace` æŒ‡å‘ã€‚ä½¿æ¯ä¸ªè¿›ç¨‹åœ¨ç³»ç»Ÿä¸­éƒ½çœ‹åˆ°å”¯ä¸€çš„å®‰è£…æ–‡ä»¶ç³»ç»Ÿ

- å”¯ä¸€çš„æ ¹ç›®å½•
- å”¯ä¸€çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„

> ä»€ä¹ˆç©æ„å„¿ï¼Ÿï¼Ÿï¼Ÿ

```c
struct mmt_namespace {
    atomic_t count;
    struct vfsmount *root;
    struct list_head list;
    wait_queue_head_t poll;
    int event;
};
```

å¯¹äºå¤šæ•°è¿›ç¨‹æ¥è¯´ï¼ŒPCB éƒ½æŒ‡å‘å”¯ä¸€çš„ `file_struct` å’Œ `fs_struct`ã€‚å¦‚æœè®¾ç½®äº†å…‹éš†æ ‡å¿—è€Œè¢«åˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹ï¼Œæ¯ä¸ªç»“æ„ä½“ä¸­éƒ½ä¼šç»´æŠ¤å¼•ç”¨è®¡æ•°ï¼Œé˜²æ­¢è¢«æ’¤é”€ã€‚
